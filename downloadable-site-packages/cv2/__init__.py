import sys
if "sphinx" not in sys.modules:

    from . import cv2
    from . import data
    from .data import *

    from Foundation import NSString

    # wildcard import above does not import "private" variables like __version__
    # this makes them available
    globals().update(cv2.__dict__)


def autorotate(frame, cam):
    """
    Returns an auto rotated frame captured with hardware camera.
    
    By default, frames captured by hardware camera will be rotated correctly only if the device is in portrait mode. By calling this function, you can make sure things like face detection will work on any device orientation.
    
    :param frame: The frame captured by the camera.
    :param cam: The camera used to capture the frame. ``0`` for back and ``1`` for front.
    """
    
    from scipy.ndimage import rotate
    from pyto import QuickLookHelper
    from PIL import Image, ImageOps
    import numpy as np
    
    rotated = rotate(frame, QuickLookHelper.openCvRotation(cam))
    
    if cam == 1:
        im = Image.fromarray(rotated)
        im = ImageOps.mirror(im)
        return np.array(im)
    else:
        return rotated

def imshow_image(title, image):
    from PIL import Image
    from io import BytesIO
    from pyto import QuickLookHelper
    import base64
    import threading
    
    image = Image.fromarray(image)
    buffered = BytesIO()
    
    try:
        image.save(buffered, format="JPEG")
    except OSError:
        return
    
    img_str = base64.b64encode(buffered.getvalue())
    img_str = NSString.alloc().initWithUTF8String(img_str)
   
    try:
        QuickLookHelper.previewFile(img_str, script=threading.current_thread().script_path, removePrevious=True)
    except AttributeError:
        QuickLookHelper.previewFile(img_str, script=None, removePrevious=True)
        
    #img_str.autorelease()
    
imshow = imshow_image
